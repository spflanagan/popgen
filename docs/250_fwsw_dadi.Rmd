---
title: Supplemental Material for "Multiple colonizations of freshwater by the Gulf pipefish reveal a shared genomic signature of adaptation"
preprint: false
author: 
  - name: Sarah P. Flanagan
    affilnum: 1
    corresponding: true
    email: spflanagan.phd@gmail.com
  - name: Emily Rose
    affilnum: 2
  - name: Adam Jones
    affilnum: 3
affiliation:
  - affilnum: 1
    affil: School of Biological Sciences, University of Canterbury, 4800 Private Bag, Christchurch 8140 New Zealand
  - affilnum: 2
    affil: Department of Biology, The University of Tampa, Tampa, FL 33606 USA
  - affilnum: 3
    affil: Department of Biological Sciences, University of Idaho, Moscow, ID 83844 USA
abstract: >
  This document includes supplementary material for the paper, showing expanded methods and results from the diffusion approximations.
header-includes: >
  \usepackage{lipsum}
  \usepackage{float}
  \floatplacement{figure}{H}
bibliography: programs.bib
output:
  bookdown::pdf_document2:
    fig_caption: yes
    keep_tex: yes
    number_sections: no
    toc: true
    toc_depth: 2
    template: manuscript.latex
  html_document: null
  word_document: null
fontsize: 11pt
capsize: normalsize
csl: molecular-ecology.csl
documentclass: article
spacing: singlespacing
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,out.extra='',fig.pos="H",
                      warning=FALSE,message=FALSE)
knitr::opts_knit$set(root.dir='../fwsw_results/')
```
```{r source}
source("../../gwscaR/R/gwscaR.R")
source("../../gwscaR/R/gwscaR_plot.R")
source("../../gwscaR/R/gwscaR_utility.R")
source("../../gwscaR/R/gwscaR_fsts.R")
source("../../gwscaR/R/gwscaR_popgen.R")
source("../../gwscaR/R/vcf2dadi.R")
source("../R/250_dadi_analysis.R")
library(knitr); library(kableExtra)
library(png)
library(scales)
pop.list<-c("ALFW","ALST","FLCC","FLLG","LAFW","TXCC","TXFW")
```



# Create a dadi SNPs file from the vcf {-}

```{r create_dadi, eval=FALSE}
vcf<-parse.vcf("stacks/populations_subset75/batch_2.vcf")
dadi<-vcf2dadiSNPs(vcf,pop.list = pop.list,filename = "dadi_analysis/fwsw.dadi.snps")
dadi<-read.delim("dadi_analysis/fwsw.dadi.snps")
projections<-unlist(lapply(pop.list,function(pop){ 
  n<-length(grep(pop,colnames(vcf)))
}))*2


names(projections)<-pop.list
best.pops<-c("TXFW","TXCB","LAFW","ALST","ALFW","FLLG","FLCC",
             "TXFW ","TXCB ","LAFW ","ALST ","ALFW ","FLLG ","FLCC ")
best.pops<-c("TXFW","TXCB","LAFW","ALST","ALFW","FLLG","FLCC",
             "TXFW.1","TXCB.1","LAFW.1","ALST.1","ALFW.1","FLLG.1","FLCC.1")
dadi<-dadi[,c("Ingroup","Outgroup","Allele1",best.pops[1:7],
              "Allele2",best.pops[8:14],"GeneID","Position")]
dim(dadi[rowSums(dadi[,colnames(dadi) %in% best.pops])==
           sum(projections[best.pops[1:7]]),])

#transform this and remove everything but population info for ease of operations
dd<-as.data.frame(cbind(colnames(dadi)[colnames(dadi) %in% best.pops],
                        t(dadi[,colnames(dadi) %in% best.pops])),
                  row.names = 0,stringsAsFactors = FALSE)
#rename the pops to be factors, essentially
dd$V1<-gsub("\\.1","",dd$V1)
#calculate sums per locus for each population
ns<-data.frame(do.call(rbind,lapply(2:ncol(dd),function(c){ 
  tapply(dd[,c],dd$V1,function(x){ sum(as.numeric(x)) }) })))
rownames(ns)<-dadi$GeneID
nozeros<-ns[!(apply(ns, 1, function(y) any(y == 0))),] #512 had zeroes
props<-apply(nozeros,2,function(x) { p<-x/max(x) } )
keepers<-props[apply(props, 1, function(y) any(y >=0.75)),]

#now save these in the dadi format
write.table(dadi[dadi$GeneID %in% rownames(keepers),],
            "dadi_analysis/fwsw.dadi.pruned.snps",
            quote=FALSE,row.names = FALSE,
            col.names = c("Ingroup","Outgroup","Allele1",
                          "TXFW","TXCB","LAFW","ALST","ALFW","FLLG","FLCC",
                          "Allele2","TXFW","TXCB","LAFW","ALST","ALFW",
                          "FLLG","FLCC","GeneID","Position"))
```

```{r check_dadis, eval=FALSE}
vcf.files<-c("stacks/populations_subset50/batch_2.vcf",
             "stacks/populations_subset75/batch_2.vcf",
             #"stacks/populations_subset85/batch_2.vcf",
             #"stacks/populations_subset90/batch_2.vcf",
             #"stacks/populations_subset95/batch_2.vcf",
             "stacks/populations_subset100/batch_2.vcf")

dadis<-lapply(vcf.files,function(file){
  full.vcf<-parse.vcf(file)
  vcf<-choose.one.snp(full.vcf)
  vcf.out.name<-gsub("batch_2.vcf","batch_2.pruned.vcf",file)
  write.table(x = vcf,file = vcf.out.name,quote = FALSE,
              sep='\t',row.names = FALSE,col.names = TRUE)
  dadi.out<-paste("dadi_analysis/fwsw",
                  gsub(".*populations_subset(\\d+).*","\\1",file),
                  ".dadi.snps",sep="")
  pop.list<-c("ALFW","ALST","FLCC","FLLG","LAFW","TXCC","TXFW")
  dadi<-vcf2dadiSNPs(vcf,pop.list = pop.list,filename = dadi.out)
  return(dadi)
})

#compare
kable(cbind(file=vcf.files,numer_snps=unlist(lapply(dadis,nrow))))
```

```{r compareSNPs}
files<-list.files(pattern="dadi.snps",path="dadi_analysis",full.names = TRUE)

dadis<-lapply(files,read.delim)
dadiSum<-data.frame(Coverage=as.numeric(gsub("dadi_analysis/fwsw(\\d+).*","\\1",files)),
               NumberSnps=do.call(rbind,lapply(dadis,nrow)))
#compare
kable(dadiSum,"latex",booktabs=TRUE,
      col.names = c("Percentage of individuals","Number of SNPs"),
      caption = "The relationship between the percentage of individuals required to be genotyped for each SNP and the total number of SNPs in the resulting dataset, once one SNP per RAD locus was removed.",)%>%
  kable_styling(latex_options=c("HOLD_position"))
```


I'm going to use the 75% of individuals dataset, which contains 12103 individuals (Table \@ref(tab:compareSNPs)) and was also used in the outlier analyses.

## Running dadi {-}

I ran the optimize functions from (dportik's $\delta_A\delta_I$ pipeline)[https://github.com/dportik/dadi_pipeline] for each pairwise combination of the 7 populations with the 26 models from [@rougeuxModelingMultipleFacets2017]. These ran using python2.7 and $\delta_A\delta_I$ v. 1.7.0, using individual scripts for each population pair and each model (in dadi_scripts/). These scripts were generated using `252_generate_dadi_scripts.sh`. Each of the population-pair-model scripts runs `252_pairwise_dadi.py`, which requires the dadi-pipeline scripts and the file `rougeux_models.py`, which contains the 26 models run here. Each script was run using either `252_run_dadi_scripts.sh` or `run_dadi_scripts_abacus.sh`, depending on whether the scripts were run on a local machine (C001KR or rccuser\@10.195.0.46) or on the cluster (abacus).


```{r dadiModels,fig.height=8,fig.width=6,dpi=300,dev='png',fig.path="../figs/", fig.cap="Schematic diagrams of each model, color-coded by base model (Strict Isolation, Isolation with Migration, Ancient Migration, or Secondary Contact). 'Linked Sel.' refers to linked selection, where a sub-section of the genome experienced a different effective population size than the remainder of the genome (hrf). 'Het. Migration' refers to differential introgression, where some regions of the genome experienced different migration rates than others. Each row demonstrates how parameters were added to the base models. Strict Isolation models contained now migration, so only linked selection and growth could be incorporated. Under Isolation with Migration scenarios, differentiating between linked selection and heterogeneous migration is difficult, so the models that combined both were not included for the Isolation with Migration scenarios."}
figPath<-"../figs/dadi_models/"
mods<-c("SI","IM","AM","SC")
adds<-c("","G","2N","2NG","2m","2mG","2N2m","2N2mG")

par(mfrow=c(8,4),oma=c(1,6,4,1),mar=c(0,0,0,0))

for(j in 1:length(adds)){
  for(i in 1:length(mods)){
    plot(c(0,1),c(0,1),type='n',axes=FALSE)
    imgName<-paste0(figPath,mods[i],adds[j],".PNG")
    if(file.exists(imgName)){
      img<-readPNG(imgName)
      rasterImage(img,0,0,1,1,xpd=TRUE)
    }
  }
}

# add headers
mtext("Strict
Isolation",side=3,outer=TRUE,at=0.125,font=2)
mtext("Isolation w/ 
Migration",side=3,outer=TRUE,at=0.375,font=2)
mtext("Ancient
Migration",side=3,outer=TRUE,at=0.62,font=2)
mtext("Secondary
Contact",side=3,outer=TRUE,at=0.875,font=2)

# add rownames
mtext("Growth",side=2,outer=TRUE,at=(7/8)-0.05,font=2,las=1,adj=0.65)
mtext("Linked Sel.",side=2,outer=TRUE,at=(6/8)-0.05,font=2,las=1,adj=0.65)
mtext("Linked Sel.+
Growth",side=2,outer=TRUE,at=(5/8)-0.05,font=2,las=1,adj=0.65)
mtext("Het. Migration",side=2,outer=TRUE,at=(4/8)-0.05,font=2,las=1,adj=0.65)
mtext("Het. Migration+
Growth",side=2,outer=TRUE,at=(3/8)-0.05,font=2,las=1,adj=0.65)
mtext("Linked Sel.+
Het. Migration",side=2,outer=TRUE,at=(2/8)-0.05,font=2,las=1,adj=0.65)
mtext("Linked Sel.+
Het. Migration+
Growth",side=2,outer=TRUE,at=(1/8)-0.05,font=2,las=1,adj=0.65)

```


Single population plots were generated using `250_dadiPlots.py`.

To run the models I saved all of the population-pair-model combinations to a file to make it easier to run specific combinations.


```{r modelCombos,eval=FALSE}
pops=c('FLLG', 'FLCC', 'ALFW', 'ALST', 'LAFW', 'TXFW', 'TXCC')   #
models=c('SI', 'IM', 'AM', 'SC', 'SI2N', 'SIG', 'SI2NG', 'IMG', 
         'IM2N', 'IM2m', 'IM2NG', 'IM2mG', 'AM2N', 'AMG', 'AM2m', 
         'AM2NG', 'AM2N2m', 'AM2mG', 'AM2N2mG', 'SCG' ,'SC2N', 
         'SC2m', 'SC2NG', 'SC2N2m' ,'SC2mG' ,'SC2N2mG')
 



############ CREATE POP COMBOS TO RUN ############
tasks=NULL
for(i in 1:(length(pops)-1)){
  for(j in (i+1):length(pops)){
    for(mod in 1:length(models)){
      tasks<-c(tasks,paste(pops[i],pops[j],models[mod],sep="_"))
    }
  }
}

write.csv(tasks,"model_list_dadi.csv",row.names = TRUE,quote=FALSE)
```



## Analyzing dadi output {-}

```{r dadi_InitialCompare}
dadi_initialCompare<-function(comparison,modSel="max"){
  opts<-dadi.modelcomp(path = paste0("dadi_results/",comparison,"/"),
                               pattern="*optimized.*",id=comparison)
  comp<-modelComparison(opts,modSel)
  Ns<-tapply(opts$log.likelihood,opts$Model,length)
  plot(as.numeric(opts$log.likelihood)~
              as.factor(opts$Model),las=3,
       ylim=c(min(as.numeric(opts$log.likelihood)-50),
              max(as.numeric(opts$log.likelihood)+50)),
        pch=19,xlab="",ylab="log likelihood")
  text(x=1:length(Ns),
       y=rep(min(as.numeric(opts$log.likelihood)-50),length(Ns)),
       Ns,cex=0.75)
  return(list(opts,comp))
}
```
```{r}
dadi_pairSummary<-function(compareList){
  sumDat<-extract_dadi_params(compareList[[2]])
  keepnames<-unique(unlist(lapply(sumDat,colnames)))
  keepnames<-keepnames[!keepnames %in% c("Replicate","params","optimized_params","rank","id")]
  keepnames<-c("PopPair",keepnames)
  sumTab<-data.frame(matrix(nrow = length(sumDat),ncol=length(keepnames),
                              dimnames = list(NULL,keepnames)))
  for(i in 1:length(sumDat)){
    sumTab[i,1]<-sumDat[[i]]$id
    sumTab[i,colnames(sumTab) %in% colnames(sumDat[[i]])]<-sumDat[[i]][,colnames(sumDat[[i]]) %in% keepnames]
  }
  return(sumTab)
}

```


To compare the $\delta_A\delta_I$ results for each population pair, we used custom functions (in the `250_dadi_analysis.R` script) to choose the run of each model with the highest median log likelihood. We opted to use the run with the median log likelihood because we observed some of our models with large log likelihoods explored paramter space not representative of all of the runs of that particular model and population pair (for example, see Figure \@ref(fig:fllgCompareMods)). We then compared log likelihoods, AIC scores, and model scores to select the best model to desribe the demographic history of each population pair. 

### FLFW vs FLCC


```{r fllgOpts, fig.cap="Comparison of log likelihoods for FLFW-FLCC models"}
fllg_flcc<-dadi_initialCompare("FLLG_FLCC",modSel="median")
```


```{r fffwTable}
sumTab<-dadi_pairSummary(fllg_flcc)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))

best_mod<-sumTab$Model[which.max(sumTab$model_score)]

```


The model with the highest median log likelihoods was `r best_mod`, with SC2mG having the second-best model score (Figre \@ref(fig:fllgOpts), Table \@ref(tab:fffwTable)). We compared the parameter estimates for these two models, visualizing the parameter estimates for each (Figure \@ref(fig:fllgCompareMods)). This figure demonstrates that the model replicate with the maximum log likelihood tended to have extreme estimates of the b1 parameter, reinforcing our choice to choose the best model runs based on median log likelihoods. 

```{r fllgBestMods}
flcc_fllg_sc2mg<-do.call(rbind,
                         extract_dadi_params(fllg_flcc[[1]][fllg_flcc[[1]]$Model==
                                                              "SC2mG",]))
flcc_fllg_im2mg<-do.call(rbind,
                         extract_dadi_params(fllg_flcc[[1]][fllg_flcc[[1]]$Model==
                                                              "IM2mG",]))
```

```{r fllgCompareMods,fig.width=8, fig.cap="Boxplot showing the parameter estimates from the replicates of the SC2mG model (left) and the IM2mG model (right) for the FLFW vs FLCC pairwise comparison. The red stars represent the model parameters from the run with the highest log likelihood."}
par(mfrow=c(1,2))
boxplot(flcc_fllg_sc2mg[,11:22],main="SC2mG")
points(1:12,
       flcc_fllg_sc2mg[which.max(flcc_fllg_sc2mg$log.likelihood),11:22],
       pch=8,col="red",lwd=2)

boxplot(flcc_fllg_im2mg[,11:21],main="IM2mG")
points(1:11,
       flcc_fllg_im2mg[which.max(flcc_fllg_im2mg$log.likelihood),11:21],
       pch=8,col="red",lwd=2)
```
```{r setupOutTable}

outNames<-colnames(sumTab)

outTable<-data.frame(matrix(nrow = 1,ncol=length(outNames),
                            dimnames = list("",outNames)))
```



```{r saveBest1}
best<-flcc_fllg_im2mg[which.max(flcc_fllg_im2mg$log.likelihood),]

outTable[1,1]<-c("FLFW_FLCC")
outTable[1,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels<-data.frame(Pop1="FLFW",
                       Pop2="FLCC",
                       Model=best_mod,
                       stringsAsFactors = FALSE)
```

Based on these results, we conclude that the FLFW and FLCC populations -- which represent a freshwater population and its nearest saltwater neighbor -- have likely experienced recent migration (which is supported by both the IM2mG and the SC2mG models), with heterogeneous migration (i.e., differential introgression) across the genome, and changes in populations sizes. 

### FLFW vs ALFW

```{r ffafOpts, fig.cap="Comparison of log likelihoods for FLFW-ALFW models" }
fllg_alfw<-dadi_initialCompare("FLLG_ALFW")
```
```{r BestMods2}


sumTab<-dadi_pairSummary(fllg_alfw)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))

best_mod<-sumTab$Model[which.max(sumTab$model_score)]
fllg_alfw_best<-do.call(rbind,
                         extract_dadi_params(fllg_alfw[[1]][fllg_alfw[[1]]$Model==best_mod,]))

```

The model with the highest median log likelihoods was `r best_mod`, which is a model including recent migration, linked selection, and changes in population sizes. These results suggest recent immigration between these two geographically isolated freshwater populations. 

```{r saveBest2}
best<-fllg_alfw_best[which.max(fllg_alfw_best$log.likelihood),]

outTable[2,1]<-c("FLFW_ALFW")
outTable[2,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]


bestModels[2,]<-c("FLFW","ALFW",Model=best_mod)
```

### FLFW vs ALST

```{r ffasOpts, fig.cap="Comparison of log likelihoods for FLFW-ALST models"}
fllg_alst<-dadi_initialCompare("FLLG_ALST")
```
```{r BestMods3}

sumTab<-dadi_pairSummary(fllg_alst)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))

best_mod<-sumTab$Model[which.max(sumTab$model_score)]
fllg_alst_best<-do.call(rbind,
                         extract_dadi_params(fllg_alst[[1]][fllg_alst[[1]]$Model==
                                                              best_mod,]))

```

The model with the highest median log likelihoods was `r best_mod`.

```{r saveBest3}
best<-fllg_alst_best[which.max(fllg_alst_best$log.likelihood),]

outTable[3,1]<-c("FLFW_ALST")
outTable[3,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]


bestModels[3,]<-c("FLFW","ALST",Model=best_mod)
```

### FLFW vs LAFW

```{r fflfOpts, fig.cap="Comparison of log likelihoods for FLFW-LAFW models"}
fllg_lafw<-dadi_initialCompare("FLLG_LAFW")
```

```{r sumTab4}
sumTab<-dadi_pairSummary(fllg_lafw)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods4}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
fllg_lafw_best<-do.call(rbind,
                         extract_dadi_params(fllg_lafw[[1]][fllg_lafw[[1]]$Model==best_mod,]))

```

The model with the highest median log likelihoods was `r best_mod`.


```{r saveBest4}
best<-fllg_lafw_best[which.max(fllg_lafw_best$log.likelihood),]

outTable[4,1]<-c("FLFW_LAFW")
outTable[4,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]


bestModels[4,]<-c("FLFW","LAFW",Model=best_mod)
```

### FLFW vs TXFW

```{r fftfOpts, fig.cap="Comparison of log likelihoods for FLFW-TXFW models"}
fllg_txfw<-dadi_initialCompare("FLLG_TXFW")
```

```{r sumTab5}
sumTab<-dadi_pairSummary(fllg_txfw)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods5}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
fllg_txfw_best<-do.call(rbind,
                         extract_dadi_params(fllg_txfw[[1]][fllg_txfw[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.

```{r saveBest5}
best<-fllg_txfw_best[which.max(fllg_txfw_best$log.likelihood),]

outTable[5,1]<-c("FLFW_TXFW")
outTable[5,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels[5,]<-c("FLFW","TXFW",Model=best_mod)
```

### FLFW vs TXCC

```{r fftsOpts, fig.cap="Comparison of log likelihoods for FLFW-TXCC models"}
fllg_txcc<-dadi_initialCompare("FLLG_TXCC")
```

```{r sumTab6}
sumTab<-dadi_pairSummary(fllg_txcc)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods6}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
fllg_txcc_best<-do.call(rbind,
                         extract_dadi_params(fllg_txcc[[1]][fllg_txcc[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.

```{r saveBest6}
best<-fllg_txcc_best[which.max(fllg_txcc_best$log.likelihood),]

outTable[6,1]<-c("FLFW_TXCC")
outTable[6,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels[6,]<-c("FLFW","TXCC",Model=best_mod)
```

### FLCC vs ALFW

```{r fsafOpts, fig.cap="Comparison of log likelihoods for FLCC-ALFW models"}
flcc_alfw<-dadi_initialCompare("FLCC_ALFW")
```

```{r sumTab7}
sumTab<-dadi_pairSummary(fllg_alfw)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods7}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
flcc_alfw_best<-do.call(rbind,
                         extract_dadi_params(flcc_alfw[[1]][flcc_alfw[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.

```{r saveBest7}
best<-flcc_alfw_best[which.max(flcc_alfw_best$log.likelihood),]

outTable[7,1]<-c("FLCC_ALFW")
outTable[7,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels[7,]<-c("FLCC","ALFW",Model=best_mod)
```

### FLCC vs ALST

```{r fsasOpts, fig.cap="Comparison of log likelihoods for FLCC-ALST models"}
flcc_alst<-dadi_initialCompare("FLCC_ALST")
```

```{r sumTab8}
sumTab<-dadi_pairSummary(fllg_alst)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods8}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
flcc_alst_best<-do.call(rbind,
                      extract_dadi_params(
                        flcc_alst[[1]][flcc_alst[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.
```{r saveBest8}
best<-flcc_alst_best[which.max(flcc_alst_best$log.likelihood),]

outTable[8,1]<-c("FLCC_ALST")
outTable[8,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]


bestModels[8,]<-c("FLCC","ALST",Model=best_mod)
```

### FLCC vs LAFW

```{r fslfOpts, fig.cap="Comparison of log likelihoods for FLCC-LAFW models"}
flcc_lafw<-dadi_initialCompare("FLCC_LAFW")
```

```{r sumTab9}
sumTab<-dadi_pairSummary(flcc_lafw)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods9}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
flcc_lafw_best<-do.call(rbind,
                      extract_dadi_params(
                        flcc_lafw[[1]][flcc_lafw[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.
```{r saveBest9}
best<-flcc_lafw_best[which.max(flcc_lafw_best$log.likelihood),]

outTable[9,1]<-c("FLCC_LAFW")
outTable[9,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels[9,]<-c("FLCC","LAFW",Model=best_mod)
```

### FLCC vs TXFW

```{r fstfOpts, fig.cap="Comparison of log likelihoods for FLCC-TXFW models"}
flcc_txfw<-dadi_initialCompare("FLCC_TXFW")
```

```{r sumTab10}
sumTab<-dadi_pairSummary(flcc_txfw)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods10}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
flcc_txfw_best<-do.call(rbind,
                      extract_dadi_params(
                        flcc_txfw[[1]][flcc_txfw[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.
```{r saveBest10}
best<-flcc_txfw_best[which.max(flcc_txfw_best$log.likelihood),]

outTable[10,1]<-c("FLCC_TXFW")
outTable[10,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels[10,]<-c("FLCC","TXFW",Model=best_mod)
```

### FLCC vs TXCC

```{r fstsOpts, fig.cap="Comparison of log likelihoods for FLCC-TXCC models"}
flcc_txcc<-dadi_initialCompare("FLCC_TXCC")
```

```{r sumTab11}
sumTab<-dadi_pairSummary(flcc_txcc)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods11}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
flcc_txcc_best<-do.call(rbind,
                      extract_dadi_params(
                        flcc_txcc[[1]][flcc_txcc[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.
```{r saveBest11}
best<-flcc_txcc_best[which.max(flcc_txcc_best$log.likelihood),]

outTable[11,1]<-c("FLCC_TXCC")
outTable[11,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels[11,]<-c("FLCC","TXCC",Model=best_mod)
```

### ALFW vs ALST

```{r afasOpts, fig.cap="Comparison of log likelihoods for ALFW-ALST models"}
alfw_alst<-dadi_initialCompare("ALFW_ALST")
```

```{r sumTab12}
sumTab<-dadi_pairSummary(alfw_alst)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods12}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
alfw_alst_best<-do.call(rbind,
                      extract_dadi_params(
                        alfw_alst[[1]][alfw_alst[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.
```{r saveBest12}
best<-alfw_alst_best[which.max(alfw_alst_best$log.likelihood),]

outTable[12,1]<-c("ALFW_ALST")
outTable[12,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels[12,]<-c("ALFW","ALST",Model=best_mod)
```

### ALFW vs LAFW

```{r aflfOpts, fig.cap="Comparison of log likelihoods for ALFW-LAFW models"}
alfw_lafw<-dadi_initialCompare("ALFW_LAFW")
```

```{r sumTab13}
sumTab<-dadi_pairSummary(alfw_lafw)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods13}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
alfw_lafw_best<-do.call(rbind,
                      extract_dadi_params(
                        alfw_lafw[[1]][alfw_lafw[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.
```{r saveBest13}
best<-alfw_lafw_best[which.max(alfw_lafw_best$log.likelihood),]

outTable[13,1]<-c("ALFW_LAFW")
outTable[13,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels[13,]<-c("ALFW","LAFW",Model=best_mod)
```

### ALFW vs TXFW

```{r aftfOpts, fig.cap="Comparison of log likelihoods for ALFW-TXFW models"}
alfw_txfw<-dadi_initialCompare("ALFW_TXFW")
```

```{r sumTab14}
sumTab<-dadi_pairSummary(alfw_txfw)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods14}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
alfw_txfw_best<-do.call(rbind,
                      extract_dadi_params(
                        alfw_txfw[[1]][alfw_txfw[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.
```{r saveBest14}
best<-alfw_txfw_best[which.max(alfw_txfw_best$log.likelihood),]

outTable[14,1]<-c("ALFW_TXFW")
outTable[14,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels[14,]<-c("ALFW","TXFW",Model=best_mod)
```


### ALFW vs TXCC

```{r aftsOpts, fig.cap="Comparison of log likelihoods for ALFW-TXCC models"}
alfw_txcc<-dadi_initialCompare("ALFW_TXCC")
```

```{r sumTab15}
sumTab<-dadi_pairSummary(alfw_txcc)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods15}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
alfw_txcc_best<-do.call(rbind,
                      extract_dadi_params(
                        alfw_txcc[[1]][alfw_txcc[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.
```{r saveBest15}
best<-alfw_txcc_best[which.max(alfw_txcc_best$log.likelihood),]

outTable[15,1]<-c("ALFW_TXCC")
outTable[15,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels[15,]<-c("ALFW","TXCC",Model=best_mod)
```


### ALST vs LAFW

```{r aslfOpts, fig.cap="Comparison of log likelihoods for ALST-LAFW models"}
alst_lafw<-dadi_initialCompare("ALST_LAFW")
```

```{r sumTab16}
sumTab<-dadi_pairSummary(alst_lafw)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods16}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
alst_lafw_best<-do.call(rbind,
                      extract_dadi_params(
                        alst_lafw[[1]][alst_lafw[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.
```{r saveBest16}
best<-alst_lafw_best[which.max(alst_lafw_best$log.likelihood),]

outTable[16,1]<-c("ALST_LAFW")
outTable[16,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels[16,]<-c("ALST","LAFW",Model=best_mod)
```


### ALST vs TXFW

```{r astfOpts, fig.cap="Comparison of log likelihoods for ALST-TXFW models"}
alst_txfw<-dadi_initialCompare("ALST_TXFW")
```

```{r sumTab17}
sumTab<-dadi_pairSummary(alst_txfw)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods17}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
alst_txfw_best<-do.call(rbind,
                      extract_dadi_params(
                        alst_txfw[[1]][alst_txfw[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.
```{r saveBest17}
best<-alst_txfw_best[which.max(alst_txfw_best$log.likelihood),]

outTable[17,1]<-c("ALST_TXFW")
outTable[17,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels[17,]<-c("ALST","TXFW",Model=best_mod)
```


### ALST vs TXCC

```{r astsOpts, fig.cap="Comparison of log likelihoods for ALST-TXCC models"}
alst_txcc<-dadi_initialCompare("ALST_TXCC")
```

```{r sumTab18}
sumTab<-dadi_pairSummary(alst_txcc)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods18}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
alst_txcc_best<-do.call(rbind,
                      extract_dadi_params(
                        alst_txcc[[1]][alst_txcc[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.
```{r saveBest18}
best<-alst_txcc_best[which.max(alst_txcc_best$log.likelihood),]

outTable[18,1]<-c("ALST_TXCC")
outTable[18,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels[18,]<-c("ALST","TXCC",Model=best_mod)
```


### LAFW vs TXFW

```{r lftfOpts, fig.cap="Comparison of log likelihoods for LAFW-TXFW models"}
lafw_txfw<-dadi_initialCompare("LAFW_TXFW")
```

```{r sumTab19}
sumTab<-dadi_pairSummary(lafw_txfw)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods19}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
lafw_txfw_best<-do.call(rbind,
                      extract_dadi_params(
                        lafw_txfw[[1]][lafw_txfw[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.
```{r saveBest19}
best<-lafw_txfw_best[which.max(lafw_txfw_best$log.likelihood),]

outTable[19,1]<-c("LAFW_TXFW")
outTable[19,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels[19,]<-c("LAFW","TXFW",Model=best_mod)
```


### LAFW vs TXCC

```{r lftsOpts, fig.cap="Comparison of log likelihoods for LAFW-TXCC models"}
lafw_txcc<-dadi_initialCompare("LAFW_TXCC")
```

```{r sumTab20}
sumTab<-dadi_pairSummary(lafw_txcc)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods20}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
lafw_txcc_best<-do.call(rbind,
                      extract_dadi_params(
                        lafw_txcc[[1]][lafw_txcc[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.
```{r saveBest20}
best<-lafw_txcc_best[which.max(lafw_txcc_best$log.likelihood),]

outTable[20,1]<-c("LAFW_TXCC")
outTable[20,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels[20,]<-c("LAFW","TXCC",Model=best_mod)
```


### TXFW vs TXCC

```{r tftsOpts, fig.cap="Comparison of log likelihoods for TXFW-TXCC models"}
txfw_txcc<-dadi_initialCompare("TXFW_TXCC")
```

```{r sumTab21}
sumTab<-dadi_pairSummary(txfw_txcc)

landscape(kable(sumTab,"latex",booktabs=TRUE,
      caption = "Table showing the results of the run with the median log likelihood for each model",
      row.names = FALSE)) %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```
```{r BestMods21}
best_mod<-sumTab$Model[which.max(sumTab$model_score)]
txfw_txcc_best<-do.call(rbind,
                      extract_dadi_params(
                        txfw_txcc[[1]][txfw_txcc[[1]]$Model==best_mod,]))
```
The model with the highest median log likelihoods was `r best_mod`.
```{r saveBest21}
best<-txfw_txcc_best[which.max(txfw_txcc_best$log.likelihood),]

outTable[21,1]<-c("TXFW_TXCC")
outTable[21,colnames(outTable) %in% colnames(best)]<-best[,colnames(best) %in% colnames(outTable)]

bestModels[21,]<-c("TXFW","TXCC",Model=best_mod)
```


## Summarizing output for best models

```{r dadiSummaryPlot,fig.width=8,fig.height=8, fig.cap="The best models for each population pair, color-coded by baseline demographic scenario (grey = strict isolation; green = ancestral migration; light blue = secondary contact; dark blue = isolation with migration). The abbreviation 2N refers to linked selection and 2m refers to heterogeneous migration/introgression, both of which are indicative of covariance among some genomic regions. The letter G indicates that the best model supports changes in population size since the population split." }
pop.list<-c(unique(bestModels[,1]),"TXCC")
colors<-c(SI="gray66",IM="#1f78b4",AM="#b2df8a",SC="#a6cee3")
lbcols<-c("#2166ac",'#1b7837',
          "#2166ac",'#af8dc3',"#2166ac",
          "#2166ac",'#762a83')
par(mfrow=c(length(pop.list),length(pop.list)),mar=c(0,0,0,0),oma=c(3,0,3,0))
for(i in 1:length(pop.list)){
  for(j in 1:length(pop.list)){
    
    exists<-nrow(bestModels[which(bestModels[,1] %in% pop.list[i] & 
                                    bestModels[,2] %in% pop.list[j]),])
    if(exists>0){
      
      model<-bestModels[which(bestModels[,1] %in% pop.list[i] &
                              bestModels[,2] %in% pop.list[j]),"Model"]
      col<-colors[names(colors) %in% gsub("(\\w\\w).*","\\1",model)]
      plot(c(0,1),c(0,1),type='n',axes=FALSE,xlab="",ylab="",bty='n')
      rect(0,0,1,1,col=alpha(col,0.75),border=col)
      legend("center",model,cex=1.5,bg='transparent',bty='n',
             adj=0.1,xjust=0,text.font = 2)
    } else{
      plot(c(0,1),c(0,1),type='n',axes=FALSE,xlab="",ylab="",bty='n')
    }
    if(i==1){
      mtext(pop.list[j],3,font = 2,outer = FALSE,cex=1.25,col=lbcols[j])
    }
    if(j==1){
      mtext(pop.list[i],2,font = 2,outer = FALSE,line=-1.6,
            cex=1.25,xpd=TRUE,col=lbcols[i])
    }
  }
}

```

The summary table will tell show all of the parameters for the best models. 

```{r showBestTable}
landscape(kable(outTable,"latex",booktabs=TRUE,
                caption="Table of all of the parameters for the best models for each population pair."))  %>%
  kable_styling(latex_options=c("scale_down","repeat_header","HOLD_position"))
```


```{r paramsOrder}
params_order<-list(SI=c("nu1", "nu2", "Ts", "O"),
                    SI2N=c("nu1", "nu2", "Ts", "nr", "bf", "O"),
                    SIG=c("nu1", "nu2", "b1", "b2", "Ts", "O" ),
                    SI2NG=c("nu1", "nu2", "b1", "b2", "hrf", "Ts", "Q", "O"),
                    IM=c("nu1", "nu2", "m12", "m21", "Ts", "O" ),
                    IMG=c("nu1", "nu2", "b1", "b2", "m12", "m21", "Ts", "O"),
                    IM2N=c("nu1", "nu2", "hrf", "m12", "m21", "Ts", "Q", "O"),
                    IM2NG=c("nu1", "nu2", "b1", "b2", "hrf", "m12", "m21", "Ts", "Q", "O"),
                    IM2m=c("nu1", "nu2", "m12", "m21", "me12", "me21", "Ts", "P", "O"),
                    IM2mG=c("nu1", "nu2", "b1", "b2", "m12", "m21", "me12", "me21", "Ts", "P", "O"),
                    AM=c("nu1", "nu2", "m12", "m21", "Ts", "Tam", "O"),
                    AMG=c("nu1", "nu2", "b1", "b2", "m12", "m21", "Tam", "Ts", "O"),
                    AM2N=c( "nu1", "nu2", "hrf", "m12", "m21", "Tam", "Ts", "Q", "O"),
                    AM2N2m=c("nu1", "nu2", "hrf", "m12", "m21", "me12", "me21", "Tam", "Ts", "P", "Q", "O"),
                   AM2NG=c("nu1", "nu2", "b1", "b2", "hrf", "m12", "m21", "Tam", "Ts", "Q", "O"),
                   AM2m=c("nu1", "nu2", "m12", "m21", "me12", "me21", "Ts", "Tam", "P", "O"),
                   AM2mG=c( "nu1", "nu2", "b1", "b2", "m12", "m21", "me12", "me21", "Tam", "Ts", "P", "O"),
                   AM2N2mG=c("nu1", "nu2", "b1", "b2", "hrf", "m12", "m21", "me12", "me21", "Tam", "Ts", "P", "Q", "O"),
                   SC=c("nu1", "nu2", "m12", "m21", "Ts", "Tsc", "O"),
                   SC2N=c("nu1", "nu2", "hrf", "m12", "m21", "Ts", "Tsc", "Q", "O"),
                   SCG=c("nu1", "nu2", "b1", "b2", "m12", "m21", "Ts", "Tsc", "O"),
                   SC2N2m=c("nu1", "nu2", "hrf", "m12", "m21", "me12", "me21", "Ts", "Tsc", "P", "Q", "O" ),
                   SC2NG=c("nu1", "nu2", "b1", "b2", "hrf", "m12", "m21", "Ts", "Tsc", "Q", "O"),
                   SC2m=c("nu1", "nu2", "m12", "m21", "me12", "me21", "Ts", "Tsc", "P", "O"),
                   SC2mG=c("nu1", "nu2", "b1", "b2", "m12", "m21", "me12", "me21", "Ts", "Tsc", "P", "O"),
                   SC2N2mG=c("nu1", "nu2", "b1", "b2", "hrf", "m12", "m21", "me12", "me21", "Ts", "Tsc", "P", "Q", "O")
                   
)
```

```{r writePythonScript}
write.table("#!/bin/bash","../scripts/make_best_plots_dadi.py",
            quote=FALSE,row.names = FALSE,col.names = FALSE)
write.table("cd \"${0%/*}\"","../scripts/make_best_plots_dadi.py",
            append=TRUE, quote=FALSE,row.names = FALSE,col.names = FALSE)
write.table("cd ../fwsw_results/dadi_results/","../scripts/make_best_plots_dadi.py",
            append=TRUE, quote=FALSE,row.names = FALSE,col.names = FALSE)
pyt_tab<-apply(outTable,1,function(dat,params_order){
  pord<-params_order[[dat["Model"]]]
  pop1<-gsub("(\\w+)_(\\w+)","\\1",dat["PopPair"])
  if(pop1=="FLFW") pop1<-"FLLG"
  pop2<-gsub("(\\w+)_(\\w+)","\\2",dat["PopPair"])
  parms<-gsub(" ","",dat[pord])
  write.table(cbind("python ../../scripts/253_plot_best_dadi.py",
                pop1,pop2,dat["Model"],parms),"../scripts/make_best_plots_dadi.py",
              append=TRUE,sep=" ",quote=FALSE,row.names = FALSE,col.names = FALSE)
},params_order=params_order)
```



## References



